#! /bin/bash

if [ ! "$CDM_HOME" ]
then
    CDM_HOME=/home/chiara/baskerville
fi

CDM_DJANGO_MANAGE=$CDM_HOME/dynamic/manage.py
DB_NAME=baskerville
DB_USER=baskerville

AZIONI="runserver syncdb backup fixtures"

function help {
    echo 
    echo "$0 -h | [ -w ] <azione> "
    echo 
    echo "<azione>: $AZIONI"
}

HOST=127.0.0.1

while getopts "hw" opzione
do
    case $opzione in
	h) help;exit;;
	w) HOST=%%SERVERIP%%;;
    esac
done

azione="${!OPTIND}"

case $azione in
    backup)
	oggi=$( date  '+%Y-%m-%d-%H%M%S' )
	fdump=$CDM_HOME/backup/pgdump_"${oggi}".sql
	mkdir -p $CDM_HOME/backup
	pg_dump -U $DB_USER $DB_NAME > $fdump
	bzip2 $fdump
	;;
    fixtures)
	app=bibliography
	fix_dir=$CDM_HOME/dynamic/$app/fixtures
	$CDM_DJANGO_MANAGE dumpdata --indent=4 ${app}.AuthorRole           > ${fix_dir}/author_roles.json
	$CDM_DJANGO_MANAGE dumpdata --indent=4 ${app}.NameType             > ${fix_dir}/name_types.json
	$CDM_DJANGO_MANAGE dumpdata --indent=4 ${app}.VolumeType           > ${fix_dir}/volume_types.json
	$CDM_DJANGO_MANAGE dumpdata --indent=4 ${app}.NameFormat           > ${fix_dir}/name_formats.json
	$CDM_DJANGO_MANAGE dumpdata --indent=4 ${app}.NameFormatCollection > ${fix_dir}/name_format_collections.json
	;;
    runserver)
	$CDM_DJANGO_MANAGE $azione $HOST:8082
	;;
    *)
	$CDM_DJANGO_MANAGE $azione
	;;
esac
