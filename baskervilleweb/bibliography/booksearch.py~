from bibliography.models import PublisherIsbn,Book,RepositoryFailedIsbn
from bibliography.webrepositories import repositories

class TemporaryAuthor(object):
    def __init__(self):
        pass

class TemporaryPublisher(object):
    def __init__(self,isbn_ced):
        self.isbn_ced=isbn_ced
        self.db_object=None
        self.name=""
        self.addresses=[]
        self.indb=False
        self.addresses_indb=False

    def set_db(self,db_object):
        self.db_object=db_object
        self.name=db_object.name
        self.addresses=db_object.addresses.all()
        self.addresses_indb=True
        self.indb=True

    def set_no_db(self,book):
        if not book.publisher: return
        self.name=book.publisher[0]
        if book.publisher[2]:
            self.addresses=book.publisher[2]
            self.addresses_indb=True
        else:
            self.addresses.append(book.publisher[1])

class TemporaryBook(object):
    def __init__(self,isbn_ced,isbn_book):
        self.isbn_ced=isbn_ced
        self.isbn_book=isbn_book
        self.authors=[]
        self.publisher=None
        self.title=""
        self.year=""
        self.indb=False

    def crc10(self):
        if not unicode(self.isbn_book).isdigit(): return('Y')
        if not unicode(self.isbn_ced).isdigit(): return('Y')
        isbn=unicode(self.isbn_ced)+unicode(self.isbn_book)
        pesi=[10,9,8,7,6,5,4,3,2]
        cod_lista=map(int,list(isbn))
        if len(cod_lista)<9:
            L=len(cod_lista)
            cod_lista+=map(lambda x: 0, range(L,9))
        crc=11-(sum(map(lambda x,y: x*y,cod_lista,pesi))%11)
        if (crc==10): return('X')
        if (crc==11): return(0)
        return(crc)

    def crc13(self):
        if not unicode(self.isbn_book).isdigit(): return('Y')
        if not unicode(self.isbn_ced).isdigit(): return('Y')
        isbn=unicode(self.isbn_ced)+unicode(self.isbn_book)
        pesi=[1,3,1,3,1,3,1,3,1,3,1,3]
        cod_lista=[9,7,8]+map(int,list(isbn))
        if len(cod_lista)<12:
            L=len(cod_lista)
            cod_lista+=map(lambda x: 0, range(L,12))
        crc=10-(sum(map(lambda x,y: x*y,cod_lista,pesi))%10)
        if (crc==10): return(0)
        return(crc)

    def look_for(self,publisher_dict):
        objs=Book.objects.filter(isbn_ced=self.isbn_ced,isbn_book=self.isbn_book)
        if len(objs)>0:
            obj=objs[0]
            self.authors=obj.bookauthorrelation_set.all()
            self.title=obj.title
            self.year=obj.year
            self.publisher=obj.publisher
            self.indb=True
            return

        if publisher_dict.has_key(self.isbn_ced):
            self.publisher=publisher_dict[self.isbn_ced][0]

        isbn_crc10=self.crc10()
        isbn_crc13=self.crc13()

        isbn10=self.isbn_ced+self.isbn_book+unicode(isbn_crc10)
        isbn13="978"+self.isbn_ced+self.isbn_book+unicode(isbn_crc13)

        print isbn10,isbn13

        for rep in repositories:
            data=rep.get_by_isbn(isbn10,isbn13)
            if data:
                print data
                if data.has_key("title"):
                    self.title=data["title"]
                if data.has_key("year"):
                    self.year=data["year"]
                if data.has_key("authors"):
                    self.authors=data["authors"]
                if not self.publisher:
                    self.publisher=(data["publisher"],data["city"],data["addresses"])
                return
        RepositoryFailedIsbn.objects.get_or_create(isbn10=isbn10,isbn13=isbn13)

def look_for(isbn_list):
    separated=[]
    isbn_ced_list=[]
    unseparated=[]
    for isbn in isbn_list:
        t=isbn.replace("-","")
        if len(t) in [12,13]:
            isbn=isbn[3:]
        if len(t) in [10,13]:
            isbn=isbn[:-1]
        isbn=isbn.strip("-")
        print isbn.replace("-","")
        t=isbn.split("-")
        if len(t)==1:
            unseparated.append(isbn)
            continue
        isbn_book=t[-1]
        isbn_ced="".join(t[:-1])
        
        separated.append( (isbn_ced,isbn_book) )
        isbn_ced_list.append(isbn_ced)


    publisher_isbn_list=PublisherIsbn.objects.filter(isbn__in=isbn_ced_list)
    publisher_dict={}
    
    for isbn in publisher_isbn_list:
        publisher_dict[isbn.isbn]=list(isbn.publisher_set.all())

        
    book_list=[]
    for isbn_ced,isbn_book in separated:
        tmp_book=TemporaryBook(isbn_ced,isbn_book)
        book_list.append(tmp_book)

    isbn_ced_list=[]
    for isbn in unseparated:
        for n in range(1,9):
            isbn_ced_list.append(isbn[:n])
    publisher_isbn_list=PublisherIsbn.objects.filter(isbn__in=isbn_ced_list)
    for isbn in publisher_isbn_list:
        publisher_dict[isbn.isbn]=list(isbn.publisher_set.all())

    for isbn in unseparated:
        for n in range(1,9):
            if publisher_dict.has_key(isbn[:n]):
                isbn_ced=isbn[:n]
                isbn_book=isbn[n:]
                tmp_book=TemporaryBook(isbn_ced,isbn_book)
                book_list.append(tmp_book)
                unseparated.remove(isbn)
                break

    for uisbn in unseparated:
        tbook=TemporaryBook("",uisbn)
        uisbn10=uisbn+tbook.crc10()
        uisbn13="978"+uisbn+tbook.crc13()
        RepositoryFailedIsbn.objects.get_or_create(isbn10=uisbn10,isbn13=uisbn13)

        
    publisher_list=[]
    author_list=[]
    n=0
    for book in book_list:
        book.look_for(publisher_dict)
        tpub=TemporaryPublisher(book.isbn_ced)
        publisher_list.append(tpub)
        if publisher_dict.has_key(tpub.isbn_ced):
            tpub.set_db(publisher_dict[tpub.isbn_ced][0])
            continue
        tpub.set_no_db(book)

    for book in book_list:
        print book.title
        print book.authors


    return {
        'unseparable': unseparated,
        'isbn_list':isbn_list,
        'publisher_list':publisher_list,
        'book_list': book_list
        }
